<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WikiGraph</title>
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="WikiGraph">
    <link rel="apple-touch-icon" href="https://live.staticflickr.com/65535/54706797821_2d5dc29827_w.jpg">
    <link rel="icon" type="image/jpeg" href="https://live.staticflickr.com/65535/54706797821_2d5dc29827_w.jpg">

    <!-- Google Fonts: Prompt -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Prompt', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'fade-in-up': 'fadeInUp 0.3s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-in-left': 'slideInLeft 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideInLeft: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseModules = { 
            initializeApp, 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken, 
            GoogleAuthProvider, 
            signInWithPopup,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, getDocs
        };
    </script>

    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
        body {
            overflow: hidden; 
            overscroll-behavior: none; /* Prevent pull-to-refresh on mobile */
        }
        .status-badge {
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }
        .status-cloud { background-color: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }
        .status-local { background-color: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }
        .status-saving { color: #d97706; }
        .status-error { color: #ef4444; background-color: #fee2e2; border: 1px solid #fca5a5; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; display: flex; align-items: center; gap: 4px; }
        .cloud-status {
            font-size: 0.75rem;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .cloud-status.saving { color: #d97706; }
        .cloud-status.saved { color: #10b981; }
        .cloud-status.error { color: #ef4444; }
        
        /* Mobile Overlay Sidebar */
        .sidebar-backdrop {
            background-color: rgba(0,0,0,0.3);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // ==========================================
        //  CONFIG
        // ==========================================
        
        const USER_FIREBASE_CONFIG = {
          apiKey: "AIzaSyChLR9pMmY1QCgD2HjJ0GjTGS5mx6tG0N8",
          authDomain: "lnwlawyer.firebaseapp.com",
          projectId: "lnwlawyer",
          storageBucket: "lnwlawyer.firebasestorage.app",
          messagingSenderId: "105328800542",
          appId: "1:105328800542:web:7be90ebd1937e98a548f0f",
          measurementId: "G-RN817Q6CXT"
        };

        // ==========================================

        // --- ICONS ---
        const IconBase = ({ children, size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        // Define Icons
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></IconBase>;
        const Plus = (props) => <IconBase {...props}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></IconBase>;
        const Share2 = (props) => <IconBase {...props}><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconBase>;
        const Maximize2 = (props) => <IconBase {...props}><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></IconBase>;
        const Minimize2 = (props) => <IconBase {...props}><polyline points="4 14 10 14 10 20"></polyline><polyline points="20 10 14 10 14 4"></polyline><line x1="14" y1="10" x2="21" y2="3"></line><line x1="3" y1="21" x2="10" y2="14"></line></IconBase>;
        const Network = (props) => <IconBase {...props}><rect x="16" y="16" width="6" height="6" rx="1"></rect><rect x="2" y="16" width="6" height="6" rx="1"></rect><rect x="9" y="2" width="6" height="6" rx="1"></rect><path d="M5 16v-3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3"></path><path d="M12 12V8"></path></IconBase>;
        const Book = (props) => <IconBase {...props}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></IconBase>;
        const Library = (props) => <IconBase {...props}><path d="m16 6 4 14"></path><path d="M12 6v14"></path><path d="M8 8v12"></path><path d="M4 4v16"></path></IconBase>;
        const FolderPlus = (props) => <IconBase {...props}><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></IconBase>;
        const Check = (props) => <IconBase {...props}><polyline points="20 6 9 17 4 12"></polyline></IconBase>;
        const X = (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></IconBase>;
        const PenTool = (props) => <IconBase {...props}><path d="m12 19 7-7 3 3-7 7-3-3z"></path><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="m2 2 7.586 7.586"></path><circle cx="11" cy="11" r="2"></circle></IconBase>;
        const MousePointer2 = (props) => <IconBase {...props}><path d="m12 6 2-2h6v6l-2 2"></path><path d="m22 22-8.5-8.5"></path><path d="M14.5 9.5 7.02 16.98c-.68.68-.69 1.77-.02 2.47l.03.03c.69.69 1.79.66 2.47-.02L16.98 12"></path></IconBase>;
        const RotateCcw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></IconBase>;
        const Palette = (props) => <IconBase {...props}><circle cx="13.5" cy="6.5" r=".5" fill="currentColor"></circle><circle cx="17.5" cy="10.5" r=".5" fill="currentColor"></circle><circle cx="8.5" cy="7.5" r=".5" fill="currentColor"></circle><circle cx="6.5" cy="12.5" r=".5" fill="currentColor"></circle><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"></path></IconBase>;
        const Cloud = (props) => <IconBase {...props}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"></path><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"></path><path d="M12 13.5V6"></path><path d="M12 6 9.5 8.5"></path><path d="M12 6l2.5 2.5"></path></IconBase>;
        const CloudCheck = (props) => <IconBase {...props}><path d="M12 21a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z"></path><path d="m9 10 2 2 4-4"></path></IconBase>;
        const HardDrive = (props) => <IconBase {...props}><line x1="22" y1="12" x2="2" y2="12"></line><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path><line x1="6" y1="16" x2="6.01" y2="16"></line><line x1="10" y1="16" x2="10.01" y2="16"></line></IconBase>;
        const User = (props) => <IconBase {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></IconBase>;
        const LogOut = (props) => <IconBase {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></IconBase>;
        const Mail = (props) => <IconBase {...props}><rect width="20" height="16" x="2" y="4" rx="2"></rect><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></IconBase>;
        const Menu = (props) => <IconBase {...props}><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></IconBase>;

        // --- CONSTANTS ---
        const INITIAL_NOTEBOOKS = [
          { id: 'nb_general', name: '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' },
          { id: 'nb_ideas', name: 'Project Ideas' }
        ];
        
        const INITIAL_NOTES = [
          {
            id: '1',
            title: 'Welcome to WikiGraph',
            content: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö Hybrid!\n\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:\n- ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô ‚òÅÔ∏è ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ô Cloud (‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÑ‡∏î‡πâ)\n- ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô üíæ ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ (Offline Mode)\n\n‡∏ñ‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô "Save Error" ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firestore Rules ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì\n\nTips:\n- ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡∏•‡∏≠‡∏á‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î Sidebar\n- ‡πÉ‡∏ô Graph View ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏≤‡∏Å‡πÇ‡∏´‡∏ô‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß',
            date: new Date().toISOString().split('T')[0],
            notebookId: 'nb_general',
            textColor: '#1e293b'
          }
        ];

        const COLORS = [
          { id: 'slate', value: '#1e293b', label: 'Black' },
          { id: 'red', value: '#ef4444', label: 'Red' },
          { id: 'blue', value: '#2563eb', label: 'Blue' },
          { id: 'green', value: '#16a34a', label: 'Green' },
          { id: 'purple', value: '#9333ea', label: 'Purple' },
          { id: 'orange', value: '#f97316', label: 'Orange' },
        ];

        // --- UTILS ---
        const generateId = () => Math.random().toString(36).substr(2, 9);

        const extractLinks = (content) => {
          const regex = /\[\[(.*?)\]\]/g;
          const links = [];
          let match;
          while ((match = regex.exec(content)) !== null) {
            links.push(match[1]);
          }
          return links;
        };

        // --- COMPONENTS ---
        
        const AuthPage = ({ onGuestLogin, error: parentError }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const [error, setError] = useState(parentError || '');
            const [loading, setLoading] = useState(false);

            useEffect(() => { if(parentError) setError(parentError); }, [parentError]);

            const handleGoogleLogin = async () => {
                setLoading(true);
                setError('');
                try {
                    const { getAuth, signInWithPopup, GoogleAuthProvider } = window.firebaseModules;
                    const auth = getAuth();
                    const provider = new GoogleAuthProvider();
                    await signInWithPopup(auth, provider);
                } catch (e) {
                    console.error(e);
                    setError(e.message || 'Login failed');
                    setLoading(false);
                }
            };

            const handleEmailAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                const { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } = window.firebaseModules;
                const auth = getAuth();
                
                try {
                    if (isRegistering) {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (e) {
                    console.error(e);
                    let msg = e.message;
                    if (e.code === 'auth/wrong-password') msg = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                    if (e.code === 'auth/user-not-found') msg = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ';
                    if (e.code === 'auth/email-already-in-use') msg = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß';
                    setError(msg || 'Authentication failed');
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4">
                    <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md border border-slate-100">
                        <div className="text-center mb-8">
                            <div className="flex items-center justify-center gap-2 mb-2">
                                <Network size={40} className="text-blue-600" />
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800">WikiGraph</h1>
                            <p className="text-slate-500 text-sm mt-1">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                        </div>

                        {error && (
                            <div className="mb-4 p-3 bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg flex items-center gap-2">
                                <AlertCircle size={16} /> {error}
                            </div>
                        )}

                        <button 
                            onClick={handleGoogleLogin}
                            disabled={loading}
                            className="w-full bg-white border border-slate-200 text-slate-700 font-medium py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 hover:bg-slate-50 transition-colors mb-4 relative"
                        >
                            Google Login
                        </button>

                        <div className="relative my-6">
                            <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-200"></div></div>
                            <div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-slate-400">‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏≠‡∏µ‡πÄ‡∏°‡∏•</span></div>
                        </div>

                        <form onSubmit={handleEmailAuth} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Email</label>
                                <div className="relative">
                                    <Mail className="absolute left-3 top-2.5 text-slate-400" size={18} />
                                    <input 
                                        type="email" 
                                        required
                                        className="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500"
                                        placeholder="your@email.com"
                                        value={email}
                                        onChange={e => setEmail(e.target.value)}
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Password</label>
                                <input 
                                    type="password" 
                                    required
                                    className="w-full px-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500"
                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                    value={password}
                                    onChange={e => setPassword(e.target.value)}
                                />
                            </div>
                            <button 
                                type="submit" 
                                disabled={loading}
                                className="w-full bg-blue-600 text-white font-medium py-2.5 px-4 rounded-lg hover:bg-blue-700 transition-colors shadow-sm shadow-blue-200"
                            >
                                {loading ? 'Processing...' : (isRegistering ? 'Create Account' : 'Sign In')}
                            </button>
                        </form>

                        <div className="mt-4 text-center text-sm">
                            <button 
                                onClick={() => setIsRegistering(!isRegistering)}
                                className="text-blue-600 hover:text-blue-700 font-medium"
                            >
                                {isRegistering ? '‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß? ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å'}
                            </button>
                        </div>

                        <div className="mt-6 pt-6 border-t border-slate-100 text-center">
                            <button onClick={onGuestLogin} className="text-slate-400 hover:text-slate-600 text-sm flex items-center justify-center gap-1 mx-auto">
                                <span>‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö Guest Local)</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const NoteItem = ({ note, isActive, onClick }) => (
          <div 
            onClick={() => onClick(note.id)}
            className={`p-3 rounded-lg cursor-pointer transition-all mb-1 flex items-center gap-3 ${
              isActive 
                ? 'bg-blue-100 text-blue-900 shadow-sm' 
                : 'hover:bg-slate-100 text-slate-700'
            }`}
          >
            <div className="relative">
                <FileText size={18} className={`flex-shrink-0 ${isActive ? 'text-blue-600' : 'text-slate-400'}`} />
                {note.drawing && (
                    <span className="absolute -top-1 -right-1 block w-2 h-2 bg-pink-500 rounded-full border border-white"></span>
                )}
            </div>
            <div className="overflow-hidden w-full">
              <h4 className="font-medium truncate text-sm">{note.title || 'Untitled'}</h4>
              <p className="text-xs text-slate-400 truncate mt-0.5 opacity-80">{note.content ? note.content.slice(0, 30) : (note.drawing ? '‡∏°‡∏µ‡∏†‡∏≤‡∏û‡∏ß‡∏≤‡∏î...' : 'Untitled Note')}</p>
            </div>
          </div>
        );

        const NotebookItem = ({ notebook, isActive, onClick, count }) => (
          <div 
            onClick={() => onClick(notebook.id)}
            className={`px-3 py-2 rounded-md cursor-pointer transition-all flex items-center justify-between text-sm mb-1 group ${
              isActive 
                ? 'bg-slate-200 text-slate-900 font-medium' 
                : 'text-slate-600 hover:bg-slate-100 hover:text-slate-900'
            }`}
          >
            <div className="flex items-center gap-2 overflow-hidden">
                <Book size={16} className={isActive ? 'text-slate-700' : 'text-slate-400 group-hover:text-slate-500'} />
                <span className="truncate">{notebook.name}</span>
            </div>
            {count > 0 && (
                <span className="text-[10px] bg-slate-200 text-slate-500 px-1.5 py-0.5 rounded-full min-w-[1.25rem] text-center group-hover:bg-white">
                    {count}
                </span>
            )}
          </div>
        );

        const DrawingCanvas = ({ initialData, onSave, className, isPointerActive, penColor }) => {
            const canvasRef = useRef(null);
            const containerRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);
            const [context, setContext] = useState(null);
            
            const setupCanvas = (canvas, imgData = null) => {
                const dpr = window.devicePixelRatio || 1;
                const rect = canvas.getBoundingClientRect();
                
                if (canvas.width !== rect.width * dpr || canvas.height !== rect.height * dpr) {
                    canvas.width = rect.width * dpr;
                    canvas.height = rect.height * dpr;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.scale(dpr, dpr);
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.lineWidth = 3;
                    ctx.strokeStyle = penColor; 
                    ctx.globalAlpha = 0.8;
                    setContext(ctx);
                    
                    const sourceData = imgData || initialData;
                    if (sourceData) {
                        const img = new Image();
                        img.onload = () => {
                            ctx.drawImage(img, 0, 0, rect.width, rect.height);
                        };
                        img.src = sourceData;
                    }
                } else if (!context) {
                    const ctx = canvas.getContext('2d');
                    ctx.scale(dpr, dpr);
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.lineWidth = 3;
                    ctx.strokeStyle = penColor; 
                    ctx.globalAlpha = 0.8;
                    setContext(ctx);
                }
            };

            useEffect(() => {
                if (context) {
                    context.strokeStyle = penColor;
                }
            }, [penColor, context]);

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;

                setupCanvas(canvas);

                const resizeObserver = new ResizeObserver(() => {
                      setupCanvas(canvas, initialData);
                });
                
                resizeObserver.observe(canvas);

                return () => resizeObserver.disconnect();
            }, [initialData]);

            const startDrawing = ({ nativeEvent }) => {
                if (!context || !isPointerActive) return;
                const { offsetX, offsetY } = getCoordinates(nativeEvent);
                context.beginPath();
                context.moveTo(offsetX, offsetY);
                setIsDrawing(true);
            };

            const draw = ({ nativeEvent }) => {
                if (!isDrawing || !context || !isPointerActive) return;
                const { offsetX, offsetY } = getCoordinates(nativeEvent);
                context.lineTo(offsetX, offsetY);
                context.stroke();
            };

            const stopDrawing = () => {
                if (!isDrawing) return;
                context.closePath();
                setIsDrawing(false);
                if (onSave && canvasRef.current) {
                    onSave(canvasRef.current.toDataURL());
                }
            };

            const getCoordinates = (event) => {
                const canvas = canvasRef.current;
                if (!canvas) return { offsetX: 0, offsetY: 0 };
                const rect = canvas.getBoundingClientRect();

                if (event.changedTouches && event.changedTouches.length > 0) {
                    return {
                        offsetX: event.changedTouches[0].clientX - rect.left,
                        offsetY: event.changedTouches[0].clientY - rect.top
                    };
                }
                
                return {
                    offsetX: event.clientX - rect.left,
                    offsetY: event.clientY - rect.top
                };
            };

            const clearCanvas = () => {
                if (context && canvasRef.current) {
                    const rect = canvasRef.current.getBoundingClientRect();
                    context.clearRect(0, 0, rect.width, rect.height);
                    onSave(null); 
                }
            };

            return (
                <div ref={containerRef} className={`relative ${className} overflow-hidden touch-none`}>
                    <canvas
                        ref={canvasRef}
                        className="w-full h-full block touch-none"
                        style={{ cursor: isPointerActive ? 'crosshair' : 'default' }}
                        onMouseDown={startDrawing}
                        onMouseMove={draw}
                        onMouseUp={stopDrawing}
                        onMouseLeave={stopDrawing}
                        onTouchStart={(e) => {
                            if (isPointerActive) {
                               // e.preventDefault(); // Handled by touch-none css
                               startDrawing(e);
                            }
                        }}
                        onTouchMove={(e) => {
                            if (isPointerActive) {
                                // e.preventDefault(); 
                                draw(e);
                            }
                        }}
                        onTouchEnd={(e) => {
                            if (isPointerActive) {
                                // e.preventDefault(); 
                                stopDrawing(e);
                            }
                        }}
                    />
                    {isPointerActive && (
                        <button 
                            onClick={clearCanvas}
                            className="absolute top-2 right-2 p-2 bg-white/90 shadow-sm border border-slate-200 rounded-full text-slate-500 hover:text-red-500 hover:bg-red-50 transition-colors z-30"
                            title="‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô"
                        >
                            <RotateCcw size={16} />
                        </button>
                    )}
                </div>
            );
        };

        const GraphView = ({ notes, onNodeClick }) => {
          const canvasRef = useRef(null);
          const [nodes, setNodes] = useState([]);
          const [links, setLinks] = useState([]);
          const draggedNodeRef = useRef(null);
          
          useEffect(() => {
            const width = canvasRef.current?.offsetWidth || 800;
            const height = canvasRef.current?.offsetHeight || 600;

            const newNodes = notes.map(note => ({
              id: note.id,
              title: note.title,
              x: Math.random() * width,
              y: Math.random() * height,
              vx: 0,
              vy: 0
            }));

            const newLinks = notes.flatMap(source => {
              const targetTitles = extractLinks(source.content || "");
              return targetTitles
                .map(targetTitle => notes.find(n => n.title === targetTitle))
                .filter(target => target)
                .map(target => ({ source: source.id, target: target.id }));
            });

            setNodes(newNodes);
            setLinks(newLinks);
          }, [notes]);

          useEffect(() => {
            const canvas = canvasRef.current;
            if (!canvas || nodes.length === 0) return;
            const ctx = canvas.getContext('2d');
            let animationFrameId;

            const animate = () => {
              const width = canvas.width;
              const height = canvas.height;
              const repulsion = 200;
              const springLength = 100;
              const k = 0.05;
              const centerForce = 0.005;

              for (let i = 0; i < nodes.length; i++) {
                let node = nodes[i];
                
                // Skip physics calc if node is being dragged
                if (node === draggedNodeRef.current) continue;

                for (let j = 0; j < nodes.length; j++) {
                  if (i === j) continue;
                  let other = nodes[j];
                  let dx = node.x - other.x;
                  let dy = node.y - other.y;
                  let dist = Math.sqrt(dx * dx + dy * dy) || 1;
                  let force = repulsion / (dist * dist);
                  node.vx += (dx / dist) * force;
                  node.vy += (dy / dist) * force;
                }
                node.vx += (width / 2 - node.x) * centerForce;
                node.vy += (height / 2 - node.y) * centerForce;
              }

              links.forEach(link => {
                let source = nodes.find(n => n.id === link.source);
                let target = nodes.find(n => n.id === link.target);
                if (source && target) {
                  let dx = target.x - source.x;
                  let dy = target.y - source.y;
                  let dist = Math.sqrt(dx * dx + dy * dy) || 1;
                  let force = (dist - springLength) * k;
                  let fx = (dx / dist) * force;
                  let fy = (dy / dist) * force;
                  
                  if (source !== draggedNodeRef.current) {
                      source.vx += fx;
                      source.vy += fy;
                  }
                  if (target !== draggedNodeRef.current) {
                      target.vx -= fx;
                      target.vy -= fy;
                  }
                }
              });

              ctx.clearRect(0, 0, width, height);
              
              ctx.strokeStyle = '#cbd5e1';
              ctx.lineWidth = 1.5;
              links.forEach(link => {
                let source = nodes.find(n => n.id === link.source);
                let target = nodes.find(n => n.id === link.target);
                if (source && target) {
                  ctx.beginPath();
                  ctx.moveTo(source.x, source.y);
                  ctx.lineTo(target.x, target.y);
                  ctx.stroke();
                }
              });

              nodes.forEach(node => {
                // Apply velocity if not dragged
                if (node !== draggedNodeRef.current) {
                    node.x += node.vx;
                    node.y += node.vy;
                    node.vx *= 0.9;
                    node.vy *= 0.9;
                }
                
                // Boundaries
                node.x = Math.max(20, Math.min(width - 20, node.x));
                node.y = Math.max(20, Math.min(height - 20, node.y));

                ctx.beginPath();
                ctx.arc(node.x, node.y, 25, 0, Math.PI * 2);
                ctx.fillStyle = node === draggedNodeRef.current ? '#eff6ff' : '#ffffff';
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.strokeStyle = node === draggedNodeRef.current ? '#2563eb' : '#3b82f6';
                ctx.stroke();

                ctx.fillStyle = '#1e293b';
                ctx.font = '12px Prompt, sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const label = node.title.length > 10 ? node.title.substring(0, 8) + '..' : node.title;
                ctx.fillText(label, node.x, node.y);
              });

              animationFrameId = requestAnimationFrame(animate);
            };

            const handleResize = () => {
              canvas.width = canvas.parentElement.offsetWidth;
              canvas.height = canvas.parentElement.offsetHeight;
            };
            window.addEventListener('resize', handleResize);
            handleResize();
            animate();

            return () => {
              window.removeEventListener('resize', handleResize);
              cancelAnimationFrame(animationFrameId);
            };
          }, [nodes, links]);

          // Interaction Helpers
          const getEventPos = (e, canvas) => {
             const rect = canvas.getBoundingClientRect();
             let clientX, clientY;
             if (e.changedTouches && e.changedTouches.length > 0) {
                 clientX = e.changedTouches[0].clientX;
                 clientY = e.changedTouches[0].clientY;
             } else {
                 clientX = e.clientX;
                 clientY = e.clientY;
             }
             return {
                 x: clientX - rect.left,
                 y: clientY - rect.top
             };
          }

          const findNodeAt = (x, y) => {
              return nodes.find(node => {
                  const dx = node.x - x;
                  const dy = node.y - y;
                  return Math.sqrt(dx*dx + dy*dy) < 30; // 30px hit radius
              });
          }

          const handleStart = (e) => {
              const pos = getEventPos(e, canvasRef.current);
              const node = findNodeAt(pos.x, pos.y);
              if (node) {
                  draggedNodeRef.current = node;
                  node.vx = 0; // Stop momentum
                  node.vy = 0;
                  // e.preventDefault(); // Prevent scroll if we hit a node
              }
          };

          const handleMove = (e) => {
              if (!draggedNodeRef.current) return;
              // e.preventDefault(); // Important for touch dragging
              const pos = getEventPos(e, canvasRef.current);
              draggedNodeRef.current.x = pos.x;
              draggedNodeRef.current.y = pos.y;
          };

          const handleEnd = (e) => {
              if (draggedNodeRef.current) {
                  // Check if it was a click (small movement) or drag
                  // For now we just treat end of drag as potential click if we want to navigate
                  // But we can separate drag vs click logic later.
                  // Current requirement is just drag.
                  draggedNodeRef.current = null;
              }
          };

          const handleClick = (e) => {
              // Separate click logic if needed, currently reusing touchstart logic partly
              const pos = getEventPos(e, canvasRef.current);
              const node = findNodeAt(pos.x, pos.y);
              if(node) onNodeClick(node.id);
          }

          return (
            <div className="w-full h-full bg-slate-50 relative overflow-hidden rounded-xl border border-slate-200 shadow-inner touch-none">
                <div className="absolute top-4 left-4 z-10 bg-white/80 backdrop-blur px-3 py-1 rounded-full text-xs font-medium text-slate-500 shadow-sm border border-slate-200 pointer-events-none">
                    Touch & Drag Enabled
                </div>
              <canvas 
                  ref={canvasRef} 
                  className="w-full h-full cursor-grab active:cursor-grabbing touch-none" 
                  onClick={handleClick}
                  onMouseDown={handleStart}
                  onMouseMove={handleMove}
                  onMouseUp={handleEnd}
                  onMouseLeave={handleEnd}
                  onTouchStart={handleStart}
                  onTouchMove={handleMove}
                  onTouchEnd={handleEnd}
              />
            </div>
          );
        };

        // --- ERROR BANNER ---
        const ErrorBanner = ({ error, onClose }) => {
            if (!error) return null;
            return (
                <div className="fixed top-0 left-0 right-0 z-50 p-4 flex justify-center pointer-events-none animate-slide-in-top">
                    <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 max-w-lg pointer-events-auto">
                        <AlertCircle className="flex-shrink-0" />
                        <div className="flex-1 text-sm">
                            <p className="font-semibold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
                            <p>{error}</p>
                            {error.includes("Missing or insufficient permissions") && (
                                <p className="mt-1 text-xs bg-red-100 p-1 rounded">
                                    üí° ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ: ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Firebase Console -> Firestore Database -> Rules ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô <code>allow read, write: if true;</code>
                                </p>
                            )}
                        </div>
                        <button onClick={onClose} className="p-1 hover:bg-red-100 rounded-full"><X size={16}/></button>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
          const [user, setUser] = useState(null);
          const [isOfflineMode, setIsOfflineMode] = useState(false);
          const [authInitialized, setAuthInitialized] = useState(false);
          
          const [notebooks, setNotebooks] = useState([]);
          const [notes, setNotes] = useState([]);
          const [activeNoteId, setActiveNoteId] = useState(null);
          const [activeNotebookId, setActiveNotebookId] = useState('all'); 
          const [searchQuery, setSearchQuery] = useState('');
          const [showGraph, setShowGraph] = useState(false);
          const [sidebarOpen, setSidebarOpen] = useState(true);
          const [toolMode, setToolMode] = useState('cursor'); 
          const [penColor, setPenColor] = useState('#ef4444'); 
          const [isCreatingNotebook, setIsCreatingNotebook] = useState(false);
          const [newNotebookName, setNewNotebookName] = useState('');
          const [saveStatus, setSaveStatus] = useState('saved'); 
          const [lastError, setLastError] = useState(null);
          
          const textareaRef = useRef(null);
          const colorInputRef = useRef(null);
          const saveTimeoutRef = useRef(null);

          // Mobile check
          useEffect(() => {
              if (window.innerWidth < 768) {
                  setSidebarOpen(false);
              }
          }, []);

          // 1. Initial Auth / Environment Check
          useEffect(() => {
              if (!window.firebaseModules) {
                  setIsOfflineMode(true);
                  setAuthInitialized(true);
                  return;
              }

              const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, signInWithCustomToken } = window.firebaseModules;
              
              let firebaseConfig = USER_FIREBASE_CONFIG;
              let usingEnvConfig = false;
              
              if (!firebaseConfig && typeof __firebase_config !== 'undefined') {
                  try {
                      firebaseConfig = JSON.parse(__firebase_config);
                      usingEnvConfig = true;
                  } catch (e) { console.error("Error parsing env config", e); }
              }

              if (firebaseConfig) {
                  try {
                      const app = initializeApp(firebaseConfig);
                      const auth = getAuth(app);
                      
                      const initAuth = async () => {
                          if (usingEnvConfig && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                              await signInWithCustomToken(auth, __initial_auth_token);
                          } else if (usingEnvConfig) {
                              await signInAnonymously(auth);
                          }
                      };
                      initAuth();

                      const unsubscribe = onAuthStateChanged(auth, (u) => {
                          setUser(u);
                          // Clear data on logout/user change to avoid stale data
                          if (!u) {
                              setNotes([]);
                              setNotebooks([]);
                              setActiveNoteId(null);
                          }
                          setIsOfflineMode(false);
                          setAuthInitialized(true);
                      });
                      return () => unsubscribe();
                  } catch (e) {
                      console.warn("Cloud init failed, falling back to local.", e);
                      setIsOfflineMode(true);
                      setAuthInitialized(true);
                  }
              } else {
                  setIsOfflineMode(true);
                  setAuthInitialized(true);
              }
          }, []);

          // Load Local Data if Offline
          useEffect(() => {
              if (isOfflineMode) {
                  const savedNotebooks = localStorage.getItem('wikigraph_notebooks');
                  const savedNotes = localStorage.getItem('wikigraph_notes');
                  if (savedNotebooks) setNotebooks(JSON.parse(savedNotebooks));
                  else setNotebooks(INITIAL_NOTEBOOKS);
                  
                  if (savedNotes) setNotes(JSON.parse(savedNotes));
                  else setNotes(INITIAL_NOTES);
              }
          }, [isOfflineMode]);

          // 2. Data Sync (Cloud)
          useEffect(() => {
              if (isOfflineMode || !user || !window.firebaseModules || !authInitialized) return;
              
              const { getFirestore, collection, onSnapshot, query } = window.firebaseModules;
              const db = getFirestore(); 
              
              const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

              const notebooksRef = collection(db, 'artifacts', appId, 'users', user.uid, 'notebooks');
              const notesRef = collection(db, 'artifacts', appId, 'users', user.uid, 'notes');

              const unsubNotebooks = onSnapshot(query(notebooksRef), (snapshot) => {
                  const items = [];
                  snapshot.forEach(doc => items.push({ ...doc.data(), id: doc.id }));
                  // Set notebooks even if empty (to clear previous user's data)
                  setNotebooks(items.length > 0 ? items : INITIAL_NOTEBOOKS);
              }, (error) => {
                  console.error("Fetch notebooks failed:", error);
                  setLastError(error.message);
                  setSaveStatus('error');
              });

              const unsubNotes = onSnapshot(query(notesRef), (snapshot) => {
                  const items = [];
                  snapshot.forEach(doc => items.push({ ...doc.data(), id: doc.id }));
                  
                  // Always update notes state
                  setNotes(items);
              }, (error) => {
                  console.error("Fetch notes failed:", error);
                  setLastError(error.message);
                  setSaveStatus('error');
              });

              return () => {
                  unsubNotebooks();
                  unsubNotes();
              };
          }, [user, isOfflineMode, authInitialized]);

          // 3. Save Logic
          const saveNote = useCallback(async (note) => {
              setSaveStatus('saving');
              setLastError(null);
              
              if (isOfflineMode) {
                  setSaveStatus('saved');
              } else {
                  if (!user || !window.firebaseModules) return;
                  const { getFirestore, doc, setDoc } = window.firebaseModules;
                  const db = getFirestore();
                  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                  try {
                      const noteRef = doc(db, 'artifacts', appId, 'users', user.uid, 'notes', note.id);
                      const cleanNote = JSON.parse(JSON.stringify(note));
                      await setDoc(noteRef, cleanNote, { merge: true });
                      setSaveStatus('saved');
                  } catch (e) {
                      console.error("Cloud save failed", e);
                      setSaveStatus('error');
                      setLastError(e.message || "Unknown error");
                  }
              }
          }, [user, isOfflineMode]);

          // Local Persist
          useEffect(() => {
              if (isOfflineMode) {
                  localStorage.setItem('wikigraph_notes', JSON.stringify(notes));
                  localStorage.setItem('wikigraph_notebooks', JSON.stringify(notebooks));
                  setSaveStatus('saved');
              }
          }, [notes, notebooks, isOfflineMode]);

          useEffect(() => {
              if (!activeNoteId && notes.length > 0) {
                  setActiveNoteId(notes[0].id);
              }
          }, [notes]);

          const debouncedSaveNote = useCallback((note) => {
              if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
              setSaveStatus('saving');
              saveTimeoutRef.current = setTimeout(() => {
                  saveNote(note);
              }, 1000); 
          }, [saveNote]);

          // Derived State
          const activeNote = useMemo(() => 
            notes.find(n => n.id === activeNoteId), 
          [notes, activeNoteId]);

          const activeNotebookName = useMemo(() => {
            if (activeNotebookId === 'all') return '‡πÇ‡∏ô‡πâ‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            return notebooks.find(nb => nb.id === activeNotebookId)?.name || '‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
          }, [notebooks, activeNotebookId]);

          const filteredNotes = useMemo(() => {
            let filtered = notes;
            if (activeNotebookId !== 'all') {
              filtered = filtered.filter(n => n.notebookId === activeNotebookId);
            }
            if (searchQuery) {
              const q = setSearchQuery.toLowerCase();
              filtered = filtered.filter(n => 
                (n.title && n.title.toLowerCase().includes(q)) || 
                (n.content && n.content.toLowerCase().includes(q))
              );
            }
            return filtered;
          }, [notes, activeNotebookId, searchQuery]);
          
          const currentColor = useMemo(() => {
              if (toolMode === 'pen') return penColor;
              return activeNote ? (activeNote.textColor || '#1e293b') : '#1e293b';
          }, [toolMode, penColor, activeNote]);

          useEffect(() => {
            if (textareaRef.current) {
                textareaRef.current.style.height = 'auto';
                textareaRef.current.style.height = textareaRef.current.scrollHeight + 'px';
            }
          }, [activeNote?.content, toolMode]);

          const handleUpdateNote = (key, value) => {
            if (!activeNoteId) return;
            const updatedNotes = notes.map(n => 
              n.id === activeNoteId ? { ...n, [key]: value } : n
            );
            setNotes(updatedNotes);
            const noteToSave = updatedNotes.find(n => n.id === activeNoteId);
            if (noteToSave) {
                debouncedSaveNote(noteToSave);
            }
          };

          const handleColorSelect = (colorValue) => {
              if (toolMode === 'pen') {
                  setPenColor(colorValue);
              } else {
                  handleUpdateNote('textColor', colorValue);
              }
          };

          const handleCreateNote = async () => {
            const newId = generateId();
            const targetNotebookId = activeNotebookId === 'all' ? (notebooks[0]?.id || 'nb_general') : activeNotebookId;
            const newNote = {
              id: newId,
              title: 'New Note',
              content: '',
              drawing: null,
              date: new Date().toISOString().split('T')[0],
              notebookId: targetNotebookId,
              textColor: '#1e293b'
            };
            setNotes([newNote, ...notes]);
            setActiveNoteId(newId);
            setToolMode('cursor');
            if (window.innerWidth < 768) setSidebarOpen(false);
            if (!isOfflineMode) saveNote(newNote);
          };

          const handleSaveNotebook = async () => {
            if (newNotebookName.trim()) {
                const newNb = { id: `nb_${generateId()}`, name: newNotebookName.trim() };
                setNotebooks([...notebooks, newNb]);
                setActiveNotebookId(newNb.id);
                setNewNotebookName('');
                setIsCreatingNotebook(false);
                if (!isOfflineMode && user && window.firebaseModules) {
                    const { getFirestore, doc, setDoc } = window.firebaseModules;
                    const db = getFirestore();
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    try {
                        const nbRef = doc(db, 'artifacts', appId, 'users', user.uid, 'notebooks', newNb.id);
                        await setDoc(nbRef, newNb);
                    } catch (e) { 
                        console.error(e); 
                        setLastError(e.message);
                        setSaveStatus('error');
                    }
                }
            } else {
                setIsCreatingNotebook(false);
            }
          };
          
          const handleCancelNotebook = () => {
              setNewNotebookName('');
              setIsCreatingNotebook(false);
          }

          const handleDeleteNote = async (id) => {
            const newNotes = notes.filter(n => n.id !== id);
            setNotes(newNotes);
            if (activeNoteId === id) {
                const remainingInView = activeNotebookId === 'all' 
                    ? newNotes 
                    : newNotes.filter(n => n.notebookId === activeNotebookId);
                
                if (remainingInView.length > 0) {
                    setActiveNoteId(remainingInView[0].id);
                } else {
                    setActiveNoteId(null);
                }
            }
            if (!isOfflineMode && user && window.firebaseModules) {
                const { getFirestore, doc, deleteDoc } = window.firebaseModules;
                const db = getFirestore();
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'notes', id));
                } catch(e) { 
                    console.error(e); 
                    setLastError(e.message);
                    setSaveStatus('error');
                }
            }
          };

          const handleSignOut = async () => {
              const { getAuth, signOut } = window.firebaseModules;
              const auth = getAuth();
              await signOut(auth);
          };
          
          const handleForceSync = () => {
             setLastError(null);
             setSaveStatus('saved');
          }

          const backlinks = useMemo(() => {
            if (!activeNote) return [];
            return notes.filter(n => {
                const links = extractLinks(n.content || "");
                return links.includes(activeNote.title);
            });
          }, [notes, activeNote]);

          // Auth State Check
          if (!authInitialized) {
              return (
                  <div className="flex items-center justify-center h-screen bg-slate-50 text-slate-400 gap-2">
                      <div className="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
                      <div className="w-2 h-2 bg-blue-500 rounded-full animate-bounce delay-75"></div>
                      <div className="w-2 h-2 bg-blue-500 rounded-full animate-bounce delay-150"></div>
                      Loading...
                  </div>
              );
          }

          // Show Login Screen if NOT offline and NO user
          if (!isOfflineMode && !user) {
              return <AuthPage onGuestLogin={() => setIsOfflineMode(true)} error={lastError} />;
          }

          return (
            <div className="flex h-screen bg-slate-50 text-slate-800 font-sans selection:bg-blue-100 selection:text-blue-900 relative">
              
              <ErrorBanner error={lastError} onClose={() => setLastError(null)} />

              {/* MOBILE BACKDROP FOR SIDEBAR */}
              {sidebarOpen && (
                  <div 
                      className="md:hidden fixed inset-0 sidebar-backdrop z-40 animate-fade-in"
                      onClick={() => setSidebarOpen(false)}
                  ></div>
              )}

              {/* SIDEBAR (Responsive) */}
              <div 
                className={`
                    fixed md:relative inset-y-0 left-0 z-50
                    w-72 bg-white border-r border-slate-200 flex flex-col 
                    transition-transform duration-300 ease-in-out shadow-2xl md:shadow-none
                    ${sidebarOpen ? 'translate-x-0' : '-translate-x-full md:w-0 md:-translate-x-full md:opacity-0'}
                `}
              >
                {/* App Title */}
                <div className="p-4 flex items-center justify-between">
                    <h1 className="text-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent flex items-center gap-2">
                      <Network size={24} className="text-blue-600"/> WikiGraph
                    </h1>
                    <button onClick={() => setSidebarOpen(false)} className="md:hidden text-slate-400 hover:text-slate-600 p-2">
                        <Minimize2 size={18} />
                    </button>
                </div>

                {/* Notebooks Section */}
                <div className="px-3 pb-2 border-b border-slate-100 flex-shrink-0">
                    <div className="flex items-center justify-between px-2 mb-1">
                        <span className="text-xs font-semibold text-slate-400 uppercase tracking-wider">Notebooks</span>
                        <button 
                            onClick={() => setIsCreatingNotebook(true)}
                            className="text-slate-400 hover:text-blue-600 p-1 rounded-md hover:bg-slate-100" 
                            title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà"
                        >
                            <FolderPlus size={14} />
                        </button>
                    </div>
                    
                    <div className="space-y-0.5 max-h-40 overflow-y-auto custom-scrollbar">
                        <div 
                            onClick={() => {
                                setActiveNotebookId('all');
                                if (window.innerWidth < 768) setSidebarOpen(false);
                            }}
                            className={`px-3 py-2 rounded-md cursor-pointer transition-all flex items-center gap-2 text-sm ${activeNotebookId === 'all' ? 'bg-slate-100 text-slate-900 font-medium' : 'text-slate-600 hover:bg-slate-50'}`}
                        >
                            <Library size={16} className={activeNotebookId === 'all' ? 'text-slate-700' : 'text-slate-400'} />
                            <span>‡πÇ‡∏ô‡πâ‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                        </div>
                        
                        {isCreatingNotebook && (
                            <div className="px-3 py-1 flex items-center gap-1 animate-fade-in">
                                <input
                                    autoFocus
                                    type="text"
                                    className="w-full text-sm border border-blue-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-100"
                                    placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏∏‡∏î..."
                                    value={newNotebookName}
                                    onChange={(e) => setNewNotebookName(e.target.value)}
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter') handleSaveNotebook();
                                        if (e.key === 'Escape') handleCancelNotebook();
                                    }}
                                />
                                <button onClick={handleSaveNotebook} className="text-green-600 hover:bg-green-50 p-1 rounded"><Check size={14}/></button>
                                <button onClick={handleCancelNotebook} className="text-red-500 hover:bg-red-50 p-1 rounded"><X size={14}/></button>
                            </div>
                        )}

                        {notebooks.map(nb => (
                            <NotebookItem 
                                key={nb.id} 
                                notebook={nb} 
                                isActive={activeNotebookId === nb.id} 
                                onClick={(id) => {
                                    setActiveNotebookId(id);
                                    if (window.innerWidth < 768) setSidebarOpen(false);
                                }}
                                count={notes.filter(n => n.notebookId === nb.id).length}
                            />
                        ))}
                    </div>
                </div>

                {/* Notes List */}
                <div className="p-3 flex-shrink-0 bg-white z-10">
                    <div className="relative mb-2">
                        <Search className="absolute left-3 top-2.5 text-slate-400" size={14} />
                        <input 
                            type="text" 
                            placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." 
                            className="w-full pl-9 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                        />
                    </div>
                     <button 
                        onClick={handleCreateNote}
                        className="w-full bg-slate-900 hover:bg-slate-800 text-white py-2 px-3 rounded-lg flex items-center justify-center gap-2 transition-colors shadow-sm text-sm font-medium"
                    >
                        <Plus size={16} /> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ô‡πâ‡∏ï‡πÉ‡∏ô "{activeNotebookName}"
                    </button>
                </div>

                <div className="flex-1 overflow-y-auto px-2 pb-4">
                  <div className="text-xs font-semibold text-slate-400 px-2 mb-2 flex justify-between items-center">
                    <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏ô‡πâ‡∏ï</span>
                    <span className="text-[10px] bg-slate-100 px-1.5 rounded text-slate-500">{filteredNotes.length}</span>
                  </div>
                  
                  {filteredNotes.length === 0 ? (
                    <div className="text-center text-slate-400 py-8 text-sm flex flex-col items-center">
                        <FileText size={24} className="mb-2 opacity-20" />
                        <span>‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏ô‡πâ‡∏ï‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</span>
                    </div>
                  ) : (
                    filteredNotes.map(note => (
                      <NoteItem 
                        key={note.id} 
                        note={note} 
                        isActive={activeNoteId === note.id} 
                        onClick={(id) => {
                            setActiveNoteId(id);
                            if (window.innerWidth < 768) setSidebarOpen(false);
                        }}
                      />
                    ))
                  )}
                </div>
              </div>


              {/* MAIN CONTENT */}
              <div className="flex-1 flex flex-col h-full relative overflow-hidden bg-white w-full">
                
                {/* Top Navigation */}
                <div className="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-4 md:px-6 flex-shrink-0 z-20">
                  <div className="flex items-center gap-3">
                      <button onClick={() => setSidebarOpen(true)} className={`p-2 hover:bg-slate-100 rounded-md text-slate-500 ${sidebarOpen ? 'md:hidden' : ''}`}>
                         {sidebarOpen ? <Menu size={18} className="md:hidden"/> : <Maximize2 size={18} />}
                         {!sidebarOpen && <span className="sr-only">Open Sidebar</span>}
                      </button>
                      
                      <div className="flex items-center text-slate-400 text-sm gap-2">
                        <span className="flex items-center gap-1 hidden sm:flex"><Book size={14}/> {notebooks.find(nb => nb.id === activeNote?.notebookId)?.name || 'General'}</span>
                        <span className="hidden sm:inline">/</span>
                        <span className="text-slate-800 font-medium truncate max-w-[150px] md:max-w-[200px]">{activeNote?.title || 'Untitled'}</span>
                      </div>
                  </div>
                  
                  <div className="flex items-center gap-2">
                    {/* Status Badge */}
                    <div className={`status-badge hidden sm:flex ${isOfflineMode ? 'status-local' : 'status-cloud'}`} title={isOfflineMode ? "Offline Mode: Saved to Browser" : "Cloud Mode: Saved to Firebase"}>
                        {isOfflineMode ? <HardDrive size={14} /> : <Cloud size={14} />}
                        <span>{isOfflineMode ? 'Local' : 'Cloud'}</span>
                    </div>
                    
                    {/* Error / Save Status */}
                    {saveStatus === 'error' ? (
                        <div className="status-error cursor-pointer" onClick={() => setLastError(lastError || "Unknown error")} title="Click to see error">
                            <AlertCircle size={14} /> <span>Error</span>
                        </div>
                    ) : (
                        <div className={`cloud-status ${saveStatus}`}>
                            {saveStatus === 'saving' ? <span className="animate-pulse flex items-center gap-1"><Cloud size={16}/></span> : <span className="flex items-center gap-1"><CloudCheck size={16}/></span>}
                        </div>
                    )}
                    
                    <button onClick={handleForceSync} title="Force Check Status" className="p-1 text-slate-400 hover:text-blue-500 hidden sm:block"><RefreshCw size={14}/></button>

                    <div className="h-6 w-px bg-slate-200 mx-1"></div>
                    <button 
                        onClick={() => setShowGraph(!showGraph)}
                        className={`flex items-center gap-2 px-2 md:px-3 py-1.5 rounded-md text-sm font-medium transition-colors border border-transparent ${showGraph ? 'bg-blue-50 text-blue-700 border-blue-100' : 'hover:bg-slate-100 text-slate-600'}`}
                    >
                        <Share2 size={16} /> <span className="hidden md:inline">Graph</span>
                    </button>
                    <button 
                        onClick={() => activeNoteId && handleDeleteNote(activeNoteId)}
                        className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-md transition-colors"
                        title="‡∏•‡∏ö‡πÇ‡∏ô‡πâ‡∏ï"
                        disabled={!activeNoteId}
                    >
                        <Trash2 size={18} />
                    </button>
                    
                    {!isOfflineMode && (
                        <button 
                            onClick={handleSignOut}
                            className="p-2 text-slate-400 hover:text-slate-700 hover:bg-slate-100 rounded-md transition-colors ml-1"
                            title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö"
                        >
                            <LogOut size={18} />
                        </button>
                    )}
                  </div>
                </div>

                {/* Workspace Area */}
                <div className={`flex-1 overflow-y-auto ${showGraph ? 'overflow-x-hidden' : ''} transition-all duration-300 relative flex flex-col md:flex-row bg-slate-50/50`}>
                    
                    {/* Editor Container */}
                    <div className={`flex-shrink-0 transition-all duration-300 ${showGraph ? 'w-full md:w-1/2 h-1/2 md:h-full border-b md:border-b-0 md:border-r border-slate-200' : 'w-full'}`}>
                        <div className={`mx-auto px-4 md:px-6 py-6 md:py-12 min-h-full bg-white shadow-sm my-0 md:my-4 md:rounded-xl md:min-h-[95%] relative ${showGraph ? 'min-w-0 max-w-none h-full overflow-y-auto' : 'max-w-4xl'}`}>
                            {activeNote ? (
                                <div className="animate-fade-in flex flex-col h-full">
                                    
                                    {/* Toolbar: Tools & Colors */}
                                    <div className="sticky top-0 z-40 flex flex-col items-center gap-2 mb-6 pointer-events-none">
                                        {/* Tool Selector */}
                                        <div className="bg-white/95 backdrop-blur border border-slate-200 shadow-lg p-1 rounded-full flex gap-1 pointer-events-auto scale-90 md:scale-100 origin-top">
                                            <button 
                                                onClick={() => setToolMode('cursor')}
                                                className={`px-4 py-1.5 rounded-full text-sm font-medium flex items-center gap-2 transition-all ${toolMode === 'cursor' ? 'bg-slate-800 text-white shadow-md' : 'text-slate-500 hover:bg-slate-100'}`}
                                                title="‡πÇ‡∏´‡∏°‡∏î‡∏û‡∏¥‡∏°‡∏û‡πå (Cursor) - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ"
                                            >
                                                <MousePointer2 size={16} /> <span className="hidden sm:inline">Type</span>
                                            </button>
                                            <button 
                                                onClick={() => setToolMode('pen')}
                                                className={`px-4 py-1.5 rounded-full text-sm font-medium flex items-center gap-2 transition-all ${toolMode === 'pen' ? 'bg-red-500 text-white shadow-md' : 'text-slate-500 hover:bg-slate-100'}`}
                                                title="‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô (Pen) - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤‡πÑ‡∏î‡πâ"
                                            >
                                                <PenTool size={16} /> <span className="hidden sm:inline">Draw</span>
                                            </button>
                                        </div>

                                        {/* Color Palette */}
                                        <div className="bg-white/95 backdrop-blur border border-slate-200 shadow-lg px-3 py-1.5 rounded-full flex items-center gap-2 pointer-events-auto animate-fade-in-up scale-90 md:scale-100 origin-top">
                                            {COLORS.map(color => (
                                                <button
                                                    key={color.id}
                                                    onClick={() => handleColorSelect(color.value)}
                                                    className={`w-6 h-6 rounded-full border border-slate-200 hover:scale-110 transition-transform ${
                                                        currentColor === color.value
                                                         ? 'ring-2 ring-offset-1 ring-blue-500' 
                                                         : ''
                                                    }`}
                                                    style={{ backgroundColor: color.value }}
                                                    title={`Select ${color.label}`}
                                                />
                                            ))}
                                            
                                            {/* Separator */}
                                            <div className="w-px h-4 bg-slate-200 mx-1"></div>
                                            
                                            {/* Custom Color Picker */}
                                            <div className="relative">
                                                <button
                                                    onClick={() => colorInputRef.current?.click()}
                                                    className={`w-6 h-6 rounded-full border border-slate-200 hover:scale-110 transition-transform flex items-center justify-center bg-slate-100 text-slate-500 ${
                                                        !COLORS.some(c => c.value === currentColor) 
                                                        ? 'ring-2 ring-offset-1 ring-blue-500' 
                                                        : ''
                                                    }`}
                                                    title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏≠‡∏¥‡∏™‡∏£‡∏∞"
                                                    style={{ 
                                                        backgroundColor: !COLORS.some(c => c.value === currentColor) ? currentColor : undefined,
                                                        color: !COLORS.some(c => c.value === currentColor) ? '#fff' : undefined 
                                                    }}
                                                >
                                                   <Palette size={12} strokeWidth={2.5} />
                                                </button>
                                                <input 
                                                    ref={colorInputRef}
                                                    type="color"
                                                    className="invisible absolute top-0 left-0 w-0 h-0 opacity-0"
                                                    onChange={(e) => handleColorSelect(e.target.value)}
                                                    value={currentColor}
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    {/* Title Input */}
                                    <input 
                                        type="text" 
                                        value={activeNote.title}
                                        onChange={(e) => handleUpdateNote('title', e.target.value)}
                                        placeholder="Note Title"
                                        className="text-2xl md:text-4xl font-bold w-full mb-6 bg-transparent border-none focus:outline-none placeholder-slate-300 text-slate-800 flex-shrink-0 relative z-30"
                                    />
                                    
                                    {/* HYBRID EDITOR AREA */}
                                    <div className="relative w-full min-h-[500px] flex-1">
                                        
                                        {/* 1. Drawing Layer (Top) */}
                                        <div className={`absolute inset-0 z-20 transition-all ${toolMode === 'pen' ? 'pointer-events-auto' : 'pointer-events-none'}`}>
                                            <DrawingCanvas 
                                                key={activeNote.id} 
                                                initialData={activeNote.drawing}
                                                onSave={(data) => handleUpdateNote('drawing', data)}
                                                className="w-full h-full"
                                                isPointerActive={toolMode === 'pen'}
                                                penColor={penColor}
                                            />
                                        </div>

                                        {/* 2. Text Layer (Bottom) */}
                                        <textarea
                                            ref={textareaRef}
                                            value={activeNote.content || ''}
                                            onChange={(e) => handleUpdateNote('content', e.target.value)}
                                            placeholder="‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°... (‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏î‡∏ó‡∏±‡∏ö)"
                                            className="w-full h-full min-h-[500px] resize-none bg-transparent border-none focus:outline-none text-base md:text-lg leading-relaxed placeholder-slate-300 font-light relative z-10 overflow-hidden"
                                            style={{ 
                                                lineHeight: '1.8',
                                                color: activeNote.textColor || '#1e293b' // Apply Text Color
                                            }}
                                        />
                                        
                                    </div>

                                    {/* Backlinks (Footer) */}
                                    {backlinks.length > 0 && (
                                        <div className="mt-12 pt-8 border-t border-slate-100 flex-shrink-0 relative z-30">
                                            <h3 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                                                <Network size={16}/> Linked References
                                            </h3>
                                            <div className="grid gap-3">
                                                {backlinks.map(link => (
                                                    <div 
                                                        key={link.id}
                                                        onClick={() => setActiveNoteId(link.id)}
                                                        className="p-4 rounded-lg bg-slate-50 border border-slate-200 hover:border-blue-300 cursor-pointer transition-all shadow-sm group"
                                                    >
                                                        <div className="font-medium text-slate-700 group-hover:text-blue-600 mb-1 flex items-center gap-2">
                                                            {link.title}
                                                            <span className="text-[10px] px-1.5 py-0.5 rounded-full bg-slate-200 text-slate-500 font-normal">
                                                                {notebooks.find(nb => nb.id === link.notebookId)?.name}
                                                            </span>
                                                        </div>
                                                        <div className="text-sm text-slate-400 line-clamp-2">{link.content}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div className="flex flex-col items-center justify-center h-full text-slate-300">
                                    <FileText size={64} className="mb-4 opacity-50" />
                                    <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ô‡πâ‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Graph Container */}
                    {showGraph && (
                        <div className="flex-shrink-0 w-full md:w-1/2 h-1/2 md:h-full bg-slate-50 p-4 shadow-inner z-10 sticky top-0 right-0">
                            <GraphView notes={filteredNotes} onNodeClick={setActiveNoteId} />
                            <div className="mt-2 text-center text-xs text-slate-400">
                                Drag to move nodes ‚Ä¢ {filteredNotes.length} notes
                            </div>
                        </div>
                    )}

                </div>
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
